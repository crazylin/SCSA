# M300配置通讯协议设计文档

## 1. 协议概述

本协议基于UDP广播机制设计，专门用于M300设备参数配置和状态查询，支持修改设备IP地址、子网掩码、网关和SN码等网络参数。协议采用二进制格式，确保数据传输的高效性和可靠性。

协议通过目标设备标识字段实现设备选择机制：
- 当目标设备标识为全0时，表示广播命令，所有设备都会响应
- 当目标设备标识为特定设备MAC地址时，只有匹配的设备会处理该命令
- 其他设备收到非自己MAC地址的命令时，会忽略该数据包

## 2. 协议结构

### 2.1 数据包格式

每个数据包由以下部分组成：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| 协议头 | 4字节 | 固定值"SCZN"，用于标识协议 |
| 版本号 | 1字节 | 协议版本号，当前为0x00 |
| 命令类型 | 1字节 | 标识操作类型 |
| 命令ID | 2字节 | 命令序列号 |
| 目标设备标识 | 6字节 | 目标设备的MAC地址，全0表示广播给所有设备 |
| 数据长度 | 4字节 | 数据区长度（字节数） |
| 数据区 | 可变长度 | 根据命令类型不同，包含不同内容 |
| CRC32校验值 | 4字节 | 用于校验数据完整性 |

### 2.2 字节序

所有多字节数据采用**小端序（Little-Endian）**编码。

### 2.3 端口配置

#### 2.3.1 默认端口

| 端口类型 | 端口号 | 描述 |
| --- | --- | --- |
| 设备监听端口 | 9222 | M300设备接收配置命令的UDP端口 |
| 上位机监听端口 | 9222 | 上位机接收设备响应的UDP端口 |

#### 2.3.2 端口使用说明

| 通信方向 | 发送方 | 接收方 | 端口配置 | 说明 |
| --- | --- | --- | --- | --- |
| **上位机→设备** | 上位机 | M300设备 | 目标端口：9222 | 上位机向广播地址（255.255.255.255:9222）发送配置命令 |
| **设备→上位机** | M300设备 | 上位机 | 源端口：9222 | 设备响应时使用9222端口向上位机发送数据 |


## 3. 命令类型定义

| 命令值 | 命令名称 | 描述 |
| --- | --- | --- |
| 0x10 | 查询设备信息 | 获取设备当前配置信息 |
| 0x11 | 设置网络配置 | 同时修改设备IP地址、子网掩码和网关 |
| 0x12 | 设置SN码 | 修改设备序列号 |
| 0x13 | 重启设备 | 使设备重新启动 |
| 0xFF | 恢复出厂设置 | 将设备恢复到默认配置 |

## 4. 数据区格式定义

### 4.1 查询设备信息 (0x10)

**请求数据区**：空

**响应数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| 设备类型 | 1字节 | 设备类型编码 |
| IP地址 | 4字节 | 设备当前IP地址 |
| 子网掩码 | 4字节 | 设备当前子网掩码 |
| 网关 | 4字节 | 设备当前默认网关 |
| MAC地址 | 6字节 | 设备MAC地址 |
| SN码 | 10字节 | 设备序列号 |
| 固件版本1 | 4字节 | Bootloader设备固件版本号 |
| 固件版本2 | 4字节 | App固件版本号 |

### 4.2 设置网络配置 (0x11)

**请求数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| IP地址 | 4字节 | 新的IP地址 |
| 子网掩码 | 4字节 | 新的子网掩码 |
| 网关 | 4字节 | 新的默认网关 |

**响应数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| 状态码 | 1字节 | 0x00表示成功，其他值表示错误 |

### 4.3 设置SN码 (0x12)

**请求数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| SN码 | 10字节 | 新的设备序列号 |

**响应数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| 状态码 | 1字节 | 0x00表示成功，其他值表示错误 |

### 4.4 重启设备 (0x13)

**请求数据区**：空

**响应数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| 状态码 | 1字节 | 0x00表示成功，其他值表示错误 |

### 4.5 恢复出厂设置 (0xFF)

**请求数据区**：空

**响应数据区**：

| 字段 | 长度 | 描述 |
| --- | --- | --- |
| 状态码 | 1字节 | 0x00表示成功，其他值表示错误 |

## 5. 错误码定义

| 错误码 | 描述 |
| --- | --- |
| 0x00 | 成功 |
| 0x01 | 参数错误 |
| 0x02 | 设备忙 |
| 0x03 | 操作超时 |
| 0x04 | 权限不足 |
| 0x05 | 内部错误 |
| 0xFF | 未知错误 |

## 6. 通信流程

### 6.1 设备发现流程

| 步骤 | 操作方 | 操作内容 | 说明 |
| --- | --- | --- | --- |
| 1 | 上位机 | 发送广播查询命令 | 向广播地址（255.255.255.255:9222）发送查询设备信息命令，目标设备标识设为全0 |
| 2 | 所有设备 | 检查并响应 | 网络中的所有设备检查目标设备标识，发现为全0（广播），均响应自身信息 |
| 3 | 上位机 | 收集响应 | 上位机收集所有响应，展示设备列表 |

### 6.2 设备配置流程

| 步骤 | 操作方 | 操作内容 | 说明 |
| --- | --- | --- | --- |
| 1 | 上位机 | 发送配置命令 | 选择特定设备，发送配置命令，目标设备标识设为该设备的MAC地址 |
| 2 | 所有设备 | 检查目标标识 | 网络中的设备接收到广播包后，检查目标设备标识 |
| 2.1 | 目标设备 | 处理命令 | 如果匹配自己的MAC地址，则处理该命令 |
| 2.2 | 其他设备 | 忽略数据包 | 如果不匹配，则忽略该数据包 |
| 3 | 目标设备 | 执行配置 | 验证参数有效性，执行配置修改，返回操作结果 |
| 4 | 目标设备 | 重启应用 | 如需要，设备重启以应用新配置 |

### 6.3 设备识别机制

| 步骤 | 处理内容 | 判断条件 | 处理结果 |
| --- | --- | --- | --- |
| 1 | 数据包验证 | 验证协议头和数据包完整性 | 通过验证后进入下一步 |
| 2 | 目标标识检查 | 检查目标设备标识字段 | 根据标识值决定处理方式 |
| 2.1 | 广播命令 | 目标标识为全0 | 所有设备处理 |
| 2.2 | 单播命令 | 目标标识匹配自己MAC地址 | 仅本设备处理 |
| 2.3 | 非目标命令 | 目标标识为其他值 | 忽略数据包 |
| 3 | 命令执行 | 符合处理条件 | 执行相应命令并响应 |

## 7. 安全性考虑

| 安全措施 | 实施方式 | 适用场景 | 重要性 |
| --- | --- | --- | --- |
| 设备认证机制 | 添加设备认证机制，防止未授权配置 | 所有网络环境 | 高 |
| 密码保护 | 对关键配置命令添加密码保护 | 敏感配置操作 | 中 |
| 加密通信 | 使用加密通信协议 | 公共网络环境 | 高 |

## 8. 示例

### 8.1 查询设备信息（广播）

**请求包结构说明**：
| 字段 | 值 | 说明 |
| --- | --- | --- |
| 协议头 | 53435A4E | "SCZN"的十六进制表示 |
| 版本号 | 00 | 协议版本0x00 |
| 命令类型 | 10 | 查询设备信息命令 |
| 命令ID | 0001 | 命令序列号1 |
| 目标设备标识 | 000000000000 | 全0表示广播 |
| 数据长度 | 00000000 | 数据区长度为0 |
| 数据区 | (空) | 查询命令无数据区 |
| CRC32校验值 | [CRC32] | 数据完整性校验 |

**响应包结构说明**（假设设备IP为192.168.1.100）：
| 字段 | 值 | 说明 |
| --- | --- | --- |
| 协议头 | 53435A4E | "SCZN"的十六进制表示 |
| 版本号 | 00 | 协议版本0x00 |
| 命令类型 | 10 | 查询设备信息命令 |
| 命令ID | 0001 | 对应请求的命令序列号 |
| 目标设备标识 | 000000000000 | 广播响应 |
| 数据长度 | 00000021 | 数据区长度33字节 |
| 设备类型 | 01 | 设备类型编码 |
| IP地址 | C0A80164 | 192.168.1.100 |
| 子网掩码 | FFFFFF00 | 255.255.255.0 |
| 网关 | C0A80101 | 192.168.1.1 |
| MAC地址 | AABBCCDDEEFF | 设备MAC地址 |
| SN码 | 534E3030303132333435363738 | "SN0001234567"的十六进制 |
| 固件版本1 | 00010001 | Bootloader版本1.1 |
| 固件版本2 | 00020003 | App版本2.3 |
| CRC32校验值 | [CRC32] | 数据完整性校验 |

### 8.2 设置网络配置（单播）

**请求包结构说明**（针对MAC地址为"AA:BB:CC:DD:EE:FF"的设备）：
| 字段 | 值 | 说明 |
| --- | --- | --- |
| 协议头 | 53435A4E | "SCZN"的十六进制表示 |
| 版本号 | 00 | 协议版本0x00 |
| 命令类型 | 11 | 设置网络配置命令 |
| 命令ID | 0002 | 命令序列号2 |
| 目标设备标识 | AABBCCDDEEFF | 目标设备MAC地址 |
| 数据长度 | 0000000C | 数据区长度12字节 |
| IP地址 | C0A801C8 | 新IP：192.168.1.200 |
| 子网掩码 | FFFFFF00 | 新掩码：255.255.255.0 |
| 网关 | C0A80101 | 新网关：192.168.1.1 |
| CRC32校验值 | [CRC32] | 数据完整性校验 |

**响应包结构说明**：
| 字段 | 值 | 说明 |
| --- | --- | --- |
| 协议头 | 53435A4E | "SCZN"的十六进制表示 |
| 版本号 | 00 | 协议版本0x00 |
| 命令类型 | 11 | 设置网络配置命令 |
| 命令ID | 0002 | 对应请求的命令序列号 |
| 目标设备标识 | AABBCCDDEEFF | 响应设备MAC地址 |
| 数据长度 | 00000001 | 数据区长度1字节 |
| 状态码 | 00 | 0x00表示成功 |
| CRC32校验值 | [CRC32] | 数据完整性校验 |

## 9. 实现注意事项

| 注意事项 | 具体要求 | 影响范围 | 建议措施 |
| --- | --- | --- | --- |
| 参数生效机制 | 所有网络参数修改后，设备需要重启才能生效 | 网络配置命令 | 在配置完成后提示用户重启设备 |
| IP地址有效性 | 修改IP地址时，应确保新地址在当前网段内 | IP地址配置 | 配置前验证IP地址的网段合法性 |
| 配置前查询 | 建议在修改网络参数前，先查询设备当前配置 | 所有配置操作 | 实现配置向导，显示当前配置信息 |
| 网络环境兼容 | 广播包可能被某些网络设备过滤 | 设备发现功能 | 考虑多网段环境下的发现机制 |